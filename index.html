<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3-queue.v3.min.js"></script>

</head>
<body>
<script type="text/javascript">
		
//Width and height of map
var width = 960;
var height = 500;

// D3 Projection
var projection = d3.geo.albersUsa()
				   .translate([width/2, height/2])    // translate to center of screen
				   .scale([1000]);          // scale things down so see entire US
        
// Define path generator
var path = d3.geo.path()               // path generator that will convert GeoJSON to SVG paths
		  	 .projection(projection);  // tell path generator to use albersUsa projection
		

//Create SVG element and append map to the SVG
var svg = d3.select("body")
			.append("svg")
			.attr("width", width)
			.attr("height", height);
        
// Append Div for tooltip to SVG
var div = d3.select("body")
		    .append("div")   
    		.attr("class", "tooltip")               
    		.style("opacity", 0);

d3.queue()
	.defer(d3.csv, "data/prosperLoanData.csv")
	.defer(d3.csv, "data/states.csv")
	.defer(d3.json, "data/us-states.json")
	.await(visualize);

function visualize(error, prosper_data, abbrev_data,usa_data) {
	if (error) { 
		console.log(error); 
	}

	var state_loan_data = d3.nest()
		.key(function(d) { 
			return d.BorrowerState;
		})
		.rollup(function(d) { 
			return d3.sum(d, function(g) {return g.LoanOriginalAmount; });
		})
		.entries(prosper_data);
		
	var state_abbrev_data = {};
	for (var i = 0; i < abbrev_data.length; i++) {
	    state_abbrev_data[abbrev_data[i].Abbreviation] = abbrev_data[i].State;
	}
	
	var maxOriginated = -1;
	
	for (var i = 0; i < state_loan_data.length; i++) {
		var state_name = state_abbrev_data[state_loan_data[i].key];
		for (var j = 0; j < usa_data.features.length; j++)  {
			var usa_state_name = usa_data.features[j].properties.name;

			if (state_name == usa_state_name) {

				usa_data.features[j].properties.originated = state_loan_data[i].values;
				 
				if (state_loan_data[i].values > maxOriginated) {
					maxOriginated = state_loan_data[i].values;
				}
				
				break;
			}
		}
	}
	// Define linear scale for output
	var color = d3.scale.linear()
			.domain([0,maxOriginated])
			.range(["lightblue","blue"]);

	
	console.log(state_abbrev_data);

	console.log(state_loan_data);
	
	console.log(usa_data.features);
	console.log(maxOriginated);
	
	svg.selectAll("path")
		.data(usa_data.features)
		.enter()
		.append("path")
		.attr("d", path)
		.style("stroke", "#fff")
		.style("stroke-width", "1")
		.style("fill", function(d) {

			// Get data value
			var value = d.properties.originated;

			if (value) {
				//If value exists…
				return color(value);
			} else {
				//If value is undefined…
				return "rgb(213,222,217)";
			}
		});
		
	var legend = d3.select("body").append("svg")
	      			.attr("class", "legend")
	     			.attr("width", 140)
	    			.attr("height", 200)
	   				.selectAll("g")
	   				.data(color.domain().slice().reverse())
	   				.enter()
	   				.append("g")
	     			.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

	  	legend.append("rect")
	   		  .attr("width", 18)
	   		  .attr("height", 18)
	   		  .style("fill", color);

	  	legend.append("text")
	  		  .data(["High","Low"])
	      	  .attr("x", 24)
	      	  .attr("y", 9)
	      	  .attr("dy", ".35em")
	      	  .text(function(d) { return d; });
		
	
};

</script>
</body>
</html>